services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "3001:3001"
      - "3002:3002"
      - "5432:5432"
      - "5678:5678"
      - "8090:8080"  # Dashboard
      - "8200:8200"
      - "11434:11434"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../ai-stack-homelab/configs/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ../ai-stack-homelab/configs/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_certs:/certs
      - traefik_logs:/var/log/traefik
    networks:
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.local`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    experimental:
      plugins:
        fail2ban:
          moduleName: "github.com/tomMoulard/fail2ban"
          version: "v0.8.9"

  vault:
    image: hashicorp/vault:latest
    container_name: vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    security_opt:
      - no-new-privileges:true
    user: root
    environment:
      VAULT_ADDR: http://0.0.0.0:8200
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
      - ./configs/vault/config.hcl:/vault/config/config.hcl:ro
    command: >
      sh -ec '
      chown -R vault:vault /vault/data /vault/logs;
      exec su vault -s /bin/sh -c "vault server -config=/vault/config/config.hcl"
      '
    networks:
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=core-network"
      - "traefik.http.routers.vault.rule=Host(`vault.local`)"
      - "traefik.http.routers.vault.entrypoints=websecure"
      - "traefik.http.routers.vault.tls=true"
      # Optional: router.service auto-resolves for single-service containers
      # - "traefik.http.routers.vault.service=vault"
      - "traefik.http.services.vault.loadbalancer.server.port=8200"
    healthcheck:
      test: ["CMD-SHELL", "vault status -address=http://127.0.0.1:8200 >/dev/null 2>&1; code=$$?; [ $$code -eq 0 ] || [ $$code -eq 2 ]"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  logto:
    image: svhd/logto:${TAG-latest}
    container_name: logto
    restart: unless-stopped
    depends_on:
      logto-db:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    environment:
      DB_URL: postgres://${LOGTO_DB_USER:-logto}:${LOGTO_DB_PASSWORD:-logto_pass}@${LOGTO_DB_HOST:-logto-db}:5432/${LOGTO_DB_NAME:-logto_db}
      LOGTO_DATABASE_URL: postgres://${LOGTO_DB_USER:-logto}:${LOGTO_DB_PASSWORD:-logto_pass}@${LOGTO_DB_HOST:-logto-db}:5432/${LOGTO_DB_NAME:-logto_db}
      LOGTO_APP_ID: ${LOGTO_APP_ID:-logto}
      LOGTO_APP_SECRET: ${LOGTO_APP_SECRET:-change-me}
      LOGTO_HOST: 0.0.0.0
      LOGTO_PORT: ${LOGTO_PORT:-3001}
      ADMIN_PORT: ${LOGTO_ADMIN_PORT:-3002}
      ENDPOINT: ${LOGTO_ENDPOINT:-https://auth.local}
      ADMIN_ENDPOINT: ${LOGTO_ADMIN_ENDPOINT:-https://auth.local:3002}
      TRUST_PROXY_HEADER: ${LOGTO_TRUST_PROXY_HEADER:-true}
    volumes:
      - logto_data:/var/lib/logto
    networks:
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=core-network"
      - "traefik.http.routers.logto.rule=Host(`auth.local`)"
      - "traefik.http.routers.logto.entrypoints=websecure"
      - "traefik.http.routers.logto.tls=true"
      - "traefik.http.routers.logto.service=logto"
      - "traefik.http.services.logto.loadbalancer.server.port=3001"
      - "traefik.http.routers.logto-admin.rule=Host(`auth.local`)"
      - "traefik.http.routers.logto-admin.entrypoints=websecure-admin"
      - "traefik.http.routers.logto-admin.tls=true"
      - "traefik.http.routers.logto-admin.service=logto-admin"
      - "traefik.http.services.logto-admin.loadbalancer.server.port=3002"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:3001/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  logto-db:
    image: postgres:18
    container_name: logto-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${LOGTO_DB_USER:-logto}
      POSTGRES_PASSWORD: ${LOGTO_DB_PASSWORD:-logto_pass}
      POSTGRES_DB: ${LOGTO_DB_NAME:-logto_db}
    volumes:
      - logto_db_data_pg18:/var/lib/postgresql
    networks:
      - core-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${LOGTO_DB_USER:-logto} -d ${LOGTO_DB_NAME:-logto_db} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-https://grafana.local}
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=core-network"
      - "traefik.http.routers.grafana.rule=Host(`grafana.local`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.service=grafana"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  core-frontend:
    build: ./services/core-frontend
    container_name: core-frontend
    restart: unless-stopped
    depends_on:
      vault:
        condition: service_started
      logto:
        condition: service_started
    environment:
      PORTAL_TITLE: ${PORTAL_TITLE:-Core Services Portal}
      VAULT_UI_URL: ${VAULT_UI_URL:-https://vault.local}
      LOGTO_UI_URL: ${LOGTO_UI_URL:-https://auth.local}
      TRAEFIK_UI_URL: ${TRAEFIK_UI_URL:-https://traefik.local}
      GRAFANA_UI_URL: ${GRAFANA_UI_URL:-https://grafana.local}
    networks:
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=core-network"
      - "traefik.http.routers.core-frontend.rule=Host(`core.local`)"
      - "traefik.http.routers.core-frontend.entrypoints=websecure"
      - "traefik.http.routers.core-frontend.tls=true"
      # Optional: router.service auto-resolves for single-service containers
      # - "traefik.http.routers.core-frontend.service=core-frontend"
      - "traefik.http.services.core-frontend.loadbalancer.server.port=5000"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:5000/health\")'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  core-network:
    driver: bridge
    name: core-network

volumes:
  traefik_certs:
    name: traefik_certs
  traefik_logs:
    name: traefik_logs
  vault_data:
    name: vault_data
  vault_logs:
    name: vault_logs
  logto_data:
    name: logto_data
  logto_db_data_pg18:
    name: logto_db_data_pg18
  grafana_data:
    name: grafana_data
